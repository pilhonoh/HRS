<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="certMapper">

	<!-- GPKI등록전 등록된  사용자ID 인지 확인 -->
	<select id="selectUser" resultType="kr.ac.skku.user.vo.COCOUsrUserVO" parameterType="kr.ac.skku.user.vo.COCOUsrUserVO">
	<![CDATA[
		SELECT  A.USER_ID as userId
			   ,A.LOGIN_ID as loginId
			   ,A.USER_PASSWD as userPasswd
			   ,A.JUMIN_NO as juminNo
		  FROM COCO_USR_M A
		 WHERE A.LOGIN_ID = #{loginId}
		   AND A.USER_PASSWD = xx1.enc_varchar2_ins(#{userPasswd} ,0,'PWD','COCO_USR_M#','USER_PASSWD')
		   AND A.JUMIN_NO LIKE SUBSTR(#{juminNo},1,6) || '%'
	]]>
	</select>
	
	<!-- 사용자 상세조회 -->
	<select id="selectCertUser" resultType="kr.ac.skku.user.vo.COCOGpkiVO" parameterType="kr.ac.skku.user.vo.COCOGpkiVO">
	<![CDATA[
		SELECT  A.USER_ID as userId
			   ,(SELECT SF_COCO_GET_JOJIKNM(B.JOJIK_CD,'KO') FROM COCO_EMP_M B WHERE B.USER_ID = A.USER_ID AND ROWNUM = 1) as jojikKname
		       ,A.USER_NM_KO as userNmKo
		       ,A.EMAIL as email
		       ,A.JUMIN_NO as juminNo
		       ,NVL(SUBSTR(JUMIN_NO,1,6),'') as juminNo1
			   ,NVL(SUBSTR(JUMIN_NO,7,13),'') as juminNo2
		       ,A.CELL_PHONE_NO as cellPhoneNo
		       ,A.HOME_TEL_NO as homeTelNo
		 FROM COCO_USR_M A
		WHERE A.USER_ID = #{userId}
	]]>
	</select>
	
	<!-- EPKI 등록 -->
	<insert id="insertCert" parameterType="kr.ac.skku.user.vo.COCOGpkiVO" >
		<![CDATA[
			INSERT INTO COCO_GPKIINS_M (
				SEQ
				, USER_ID
				, JOJIK_KNAME
				, USER_NM_KO
				, EMAIL
				, JUMIN_NO
				, CELL_PHONE_NO
				, HOME_TEL_NO
				, APP_KIND1
				, APP_KIND2
				, IMSI_PW
				, FLAG
				, UPD_DT
			) VALUES (
			    (SELECT NVL(MAX(seq), 0) + 1 FROM COCO_GPKIINS_M)
			    , #{userId}
			    , #{jojikKname}
			    , #{userNmKo}
			    , #{email}
			    , #{juminNo}
			    , #{cellPhoneNo}
			    , #{homeTelNo}
			    , #{appKind1}
			    , #{appKind2}
			    , #{imsiPw}
			    , #{flag}
			    , SYSDATE
		    )
		]]>
	    <selectKey resultType="string" keyProperty="SEQ" order="AFTER">
	        SELECT LAST_INSERT_ID()
	    </selectKey>   
	</insert>
	
	<!-- 인증서 등록 확인 -->
	<select id="selectGpki" resultType="kr.ac.skku.user.vo.COCOGpkiVO" parameterType="kr.ac.skku.user.vo.COCOGpkiVO">
	<![CDATA[
        SELECT
        	USER_ID as dn
        FROM COCO_GPKI_M
       	WHERE
   			USER_ID = #{userId}
      	AND
			DN = #{dn}
	]]>
	</select>
	<!-- GPKI 등록 -->
	<insert id="insertGpki" parameterType="kr.ac.skku.user.vo.COCOGpkiVO">
		<![CDATA[
			INSERT INTO COCO_GPKI_M (
				USER_ID
				, DN
				, UPD_DT
			) VALUES (
				#{userId}
				, #{dn}
				, SYSDATE
			)
		]]>
	</insert>
</mapper>