<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="COCOUsrLogin">

	<select id="loginUserInfo">
		<![CDATA[
			SELECT T.USER_ID
				  ,T.USER_NM_KO
				  ,T.LOGIN_ID
				  ,T.JUMIN_NO
				  ,T.USER_PASSWD
			   	  ,DECODE(T.USER_PASSWD,xx1.enc_varchar2_ins(:vo.userPasswd ,0,'PWD','COCO_USR_M#','USER_PASSWD'),'Y','N') IS_USER
				  ,DECODE(T.USER_GB,'0', 
                                       DECODE((SELECT 1 FROM COCO_HPUSRMAP_M S WHERE S.LOGIN_ID=T.LOGIN_ID),1,'9','0'), T.USER_GB) USER_GB
				  ,TO_CHAR(SYSDATE,'yyyy-mm-dd hh24:mi:ss') LAST_LOGIN_DT
				  ,CASE WHEN EMP_CNT > 0 THEN 'E'
				        WHEN STD_CNT > 0 THEN 'S'
				        ELSE 'G'
				   END USER_TYPE
				  ,S.PASSWD_FAIL_CNT + DECODE(T.USER_PASSWD,xx1.enc_varchar2_ins(:vo.userPasswd ,0,'PWD','COCO_USR_M#','USER_PASSWD'),0,1) PASSWD_FAIL_CNT
				  ,S.PASSWD_CHG_PERIOD
				  ,DECODE(T.LOCK_USE_YN,'N','N',S.LOCKED_YN) LOCKED_YN
				  ,CASE WHEN S.LOCK_TYPE != 'N' THEN S.LOCK_TYPE
				  		ELSE NVL((SELECT DECODE(G.USR_DEF_CD1, '0', 'N', G.USR_DEF_CD1 ) FROM COCO_COMCD_D G WHERE G.GRP_CD='USER_SECURITY' AND G.COM_CD='LOC_CNT'),'N')
				   END LOCK_TYPE					  
				  ,S.UNLOCK_TYPE
				  ,DECODE(T.LOGIN_NOTI_USE_YN, 'N', 'N', NVL(S.LOGIN_NOTI_TYPE,'N')) LOGIN_NOTI_TYPE
				  ,CASE WHEN (UPDATE_PASSWD_USE_YN = 'Y' AND ADD_MONTHS(NVL(S.LAST_PASSWD_UPD_DT,SYSDATE), NVL(S.PASSWD_CHG_PERIOD,6)) < SYSDATE) THEN 'Y'
				        ELSE 'N' END PAST_UPD_PASSWD
				  ,T.LOCK_USE_YN
				  ,T.CALL_CENTER_TEL
				  ,NVL((SELECT 'Y' FROM COCO_GPKI_M G WHERE T.USER_ID = G.USER_ID ),'N') CERT_USE_YN
				  ,SF_COCO_USER_LOCK_CHECK(S.LOCK_TYPE, S.PASSWD_FAIL_CNT + DECODE(T.USER_PASSWD,xx1.enc_varchar2_ins(:vo.userPasswd ,0,'PWD','COCO_USR_M#','USER_PASSWD'),0,1) ) PRE_CHECK_LOCKED_YN
			  FROM (
					SELECT A.USER_ID
						  ,A.USER_NM_KO
						  ,A.LOGIN_ID
						  ,A.JUMIN_NO
						  ,A.USER_PASSWD
						  ,A.USER_GB
						  ,(SELECT COUNT(1) FROM COCO_EMP_M B WHERE A.USER_ID=B.USER_ID) EMP_CNT
	                      ,(SELECT COUNT(1) FROM COCO_STD_M B WHERE A.USER_ID=B.USER_ID) STD_CNT
						  ,NVL((SELECT C.USR_DEF_CD1 FROM COCO_COMCD_D C WHERE C.GRP_CD='USER_SECURITY' AND C.COM_CD='UPD'),'N') UPDATE_PASSWD_USE_YN
						  ,NVL((SELECT C.USR_DEF_CD1 FROM COCO_COMCD_D C WHERE C.GRP_CD='USER_SECURITY' AND C.COM_CD='LOC'),'N') LOCK_USE_YN
						  ,NVL((SELECT C.USR_DEF_CD1 FROM COCO_COMCD_D C WHERE C.GRP_CD='USER_SECURITY' AND C.COM_CD='NOT'),'N') LOGIN_NOTI_USE_YN
						  ,NVL((SELECT C.USR_DEF_CD1 FROM COCO_COMCD_D C WHERE C.GRP_CD='USER_SECURITY' AND C.COM_CD='TEL'),'031-299-6119') CALL_CENTER_TEL
					  FROM COCO_USR_M A
					 WHERE A.LOGIN_ID = :vo.loginId
					   AND A.USE_YN = 'Y'
				#if($vo.SKEY.equals('SYSHSSE002'))	--사서학생
					   AND EXISTS (SELECT 1
					   				 FROM HSMGR.HSSE_HAKJUK_M B
					   				WHERE B.USER_ID=A.USER_ID
					   				UNION 
					   			   SELECT 1
					   			     FROM HSMGR.HSSE_WONSU_M C
					   				WHERE C.USER_ID=A.USER_ID
					   				  AND C.SAJUNG_RESULT='01')
				#end
				#if($vo.SKEY.equals('SYSHSLK002'))	--한국어과정학생
					   AND EXISTS (SELECT 1
					   				 FROM HSMGR.HSLK_STUDENT_M B
					   				WHERE B.USER_ID=A.USER_ID)
				#end
				#if($vo.SKEY.equals('SYSHSLA001') || $vo.SKEY.equals('SYSHSLK001') || $vo.SKEY.equals('SYSHSSE001'))	--사서,어학원,한국어 교강사
					   AND EXISTS (SELECT 1
					   				 FROM COCO_EMP_M B
					   				WHERE B.USER_ID=A.USER_ID)
				#end
					) T
					,COCO_USR_D S
			   WHERE T.USER_ID=S.USER_ID(+)
		]]>
	</select>

</mapper>